var usersApp = angular.module("usersApp", []);

document.getElementById("orderPopup").style.display = "none";

var activeFiltler = document.getElementsByClassName('filters-order-active');
usersApp.service('filters', function () {
    var self = this;
    self.filterUserDate = function() {
        var rating = document.getElementsByClassName('list-user-rating');
        var date = document.getElementsByClassName('list-user-date');
        for (i = 0; i < rating.length; i++) {
            rating[i].style.display = "none";
        }
        for (i = 0; i < date.length; i++) {
            date[i].style.display = "block";
        }
        activeFiltler[0].innerHTML = "By Date";
        self.showRateOrDate();
    }
    self.filterUserRate = function (){
        var rating = document.getElementsByClassName('list-user-rating');
        var date = document.getElementsByClassName('list-user-date');
        for (i = 0; i < date.length; i++) {
            date[i].style.display = "none";
        }
        for (i = 0; i < rating.length; i++) {
            rating[i].style.display = "block";
        }
        activeFiltler[0].innerHTML = "By Rating";
        self.showRateOrDate();
    }
    self.showRateOrDate = function() {
        var toggle = document.getElementById("orderPopup").style.display;
        if (toggle == "none") {
            document.getElementById("orderPopup").style.display = "flex";
        } else {
            document.getElementById("orderPopup").style.display = "none";
        }
    }
})
usersApp.service('popups', function () {
	var self = this;
	self.show = function (element) {
        document.getElementById(element).style.display = "flex";
        document.getElementById("popupsContainer").style.display = "flex";
        if (document.body.offsetHeight > window.innerHeight) {
            document.body.style.overflow = 'hidden';
            document.body.style.paddingRight = '15px';
        };
    };
    self.hide = function (element) {
        document.getElementById(element).style.display = "flex";
        document.getElementById("popupsContainer").style.display = "none";
        document.body.style.overflow = 'auto';
        document.body.style.paddingRight = '0';
    };
    self.fillProfile = function (event) {
        var editForm = document.getElementById('EditForm'),
        input = editForm.getElementsByTagName("input");
        input[0].value = event.user._id;
        input[1].value = event.user.username;
        input[2].value = event.user.email;
        input[3].value = event.user.post;
        input[4].value = event.user.phone;
        input[5].value = event.user.password;
        input[6].value = event.user.fullname;
    }
});
usersApp.service('control', ['popups', function (popups) {
    var self = this;
    self.submitAddForm = function(isValid){
        if (isValid){
            $.post('http://localhost:4000/add', $('#add').serialize(), function(response) {
                if (response.error !== undefined) {
                    if (response.error === "This login duplicate") {
                        document.getElementsByClassName('login-used')[0].style.display = "block";
                    } else if (response.error === "This email duplicate") {
                        document.getElementsByClassName('email-used')[0].style.display = "block";
                    }
                } else {
                    popups.hide('AddForm');
                    document.getElementsByClassName('login-used')[0].style.display = "none";
                    document.getElementsByClassName('email-used')[0].style.display = "none";
                }
            });
        };
    };

    self.submitEditForm = function(isValid) {
        if (isValid){
			var id = document.getElementById('userEdit').getElementsByTagName('input')[0].value;			
            $.post('http://localhost:4000/update/' + id, $('#userEdit').serialize(), function(response) {
                if (response.error !== undefined) {
                    if (response.error === "This email duplicate") {
                        document.getElementsByClassName('email-used')[0].style.display = "block";
                    }
                } else {
                    popups.hide('EditForm');
                    document.getElementsByClassName('email-used')[0].style.display = "none";
                    // location.reload(true)
                }
            });
        };
    }
    self.deleteUser = function(deleteBtn) {
        var id = deleteBtn.parentNode.id;
        $.post('http://localhost:4000/delete/' + id);
        var deleted = deleteBtn.parentNode.parentNode.parentNode.style.display= "none";
    }
}])
usersApp.controller('usersController',['$scope', '$http', 'popups', 'filters', 'control', function($scope, $http, popups, filters, control) {
    $scope.openProfile = function(event){
        popups.show('EditForm');
        popups.fillProfile(event);
    }
    $scope.filterRateOrDate = function(){
        filters.showRateOrDate();
    }
    $scope.filterByRating = function(){
        filters.filterUserRate();
    }
    $scope.filterByDate = function(){
        filters.filterUserDate();
    }
	$scope.showAddForm = function(){popups.show('AddForm');}
    $scope.hideAddForm = function(){popups.hide('AddForm');}
    $scope.hideProfile = function(){popups.hide('EditForm');}

    $scope.editSubmitForm = function () {
        control.submitEditForm('userEdit.$valid');
    }
    $scope.addSubmitForm = function () {
        control.submitAddForm('userAdd.$valid');
    }
    $scope.deleteUser = function(deleteBtn) {
        control.deleteUser(deleteBtn);
    }

    $.get('http://localhost:4000/users').then(function(response) { 
        $scope.users = {
            info: response
        };
    });
    $scope.counter = 0;
    $scope.currentPage = 0;
    $scope.pageSize = 15;
    $scope.numberOfPages = function() {
    	if ($scope.users !== undefined) {
            return Math.ceil($scope.users.info.length / $scope.pageSize);
        }
	}
}]);


