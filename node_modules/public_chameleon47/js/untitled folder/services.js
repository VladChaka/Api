usersApp.service('popups', function() {
    var self = this;
    self.show = function(element) {
        document.getElementById(element).style.display = "flex";
        document.getElementById("popupsContainer").style.display = "flex";
        if (document.body.offsetHeight > window.innerHeight) {
            document.body.style.overflow = 'hidden';
            document.body.style.paddingRight = '15px';
        };
    };
    self.hide = function(element) {
		var elem = document.getElementById(element);
		elem.style.display = "none";
		var input = input = elem.getElementsByTagName("input");
		for (let i = 0; i < 6; i++) {
			input[i].value = '';
		}
		document.getElementsByClassName('add-login-used')[0].style.display = "none";
		document.getElementsByClassName('add-email-used')[0].style.display = "none";
        document.getElementsByClassName('edit-email-used')[0].style.display = "none";
        document.getElementById("popupsContainer").style.display = "none";
        document.body.style.overflow = 'auto';
        document.body.style.paddingRight = '0';
    };
});
usersApp.service('filters', function() {
    var self = this;
    var activeFilter = document.getElementsByClassName('filters-order-active');
    self.filterUserDate = function() {
        var rating = document.getElementsByClassName('list-user-rating');
        var date = document.getElementsByClassName('list-user-date');
        for (i = 0; i < rating.length; i++) {
            rating[i].style.display = "none";
        }
        for (i = 0; i < date.length; i++) {
            date[i].style.display = "block";
        }
        activeFilter[0].innerHTML = "By Date";
        self.showRateOrDate();
    }
    self.filterUserRate = function() {
        var rating = document.getElementsByClassName('list-user-rating');
        var date = document.getElementsByClassName('list-user-date');
        for (i = 0; i < date.length; i++) {
            date[i].style.display = "none";
        }
        for (i = 0; i < rating.length; i++) {
            rating[i].style.display = "block";
        }
        activeFilter[0].innerHTML = "By Rating";
        self.showRateOrDate();
    }
    self.showRateOrDate = function() {
        var toggle = document.getElementById("orderPopup").style.display;
        if (toggle == "none") {
            document.getElementById("orderPopup").style.display = "flex";
        } else {
            document.getElementById("orderPopup").style.display = "none";
        }
    }
})

usersApp.service('control', ['popups', 'deleteUser', 'addUser', 'updateUser', 'getUser', function(popups, deleteUser, addUser, updateUser, getUser) {
    var self = this;
    self.deleteUser = function(deleteBtn) {
        var id = deleteBtn.parentNode.id;
        deleteUser.delete({ userId: id });
        deleteBtn.parentNode.parentNode.style.display = "none";
    }
    self.submitAddForm = function(isValid) {
        if (isValid) {
            let data = document.getElementById("add"),
                input = data.getElementsByTagName("input"),
                dataJson = {
                    username: input[0].value,
                    email: input[1].value,
                    post: input[2].value,
                    phone: input[3].value,
                    password: input[4].value,
                    fullname: input[5].value
                };					

            addUser.save(dataJson, function(response) {
                if (response.error !== undefined) {
                    if (response.error === "This login duplicate") {
                        document.getElementsByClassName('add-login-used')[0].style.display = "block";
                    } else if (response.error === "This email duplicate") {
                        document.getElementsByClassName('add-email-used')[0].style.display = "block";
                    }
                } else {
                    popups.hide('AddForm');
                }
            });
        };
    };

    self.submitEditForm = function(isValid) {
        if (isValid) {
            document.getElementsByClassName('edit-email-used')[0].style.display = "none";
            var id = document.getElementById('userEdit').getElementsByTagName('input')[0].value;
            let data = document.getElementById("EditForm"),
                input = data.getElementsByTagName("input"),
                dataJson = {
                    id: id,
                    email: input[2].value,
                    post: input[3].value,
                    phone: input[4].value,
                    password: input[5].value,
                    fullname: input[6].value
                };

            updateUser.save(dataJson, function(response) {
                if (response.error !== undefined) {
                    if (response.error === "This email duplicate") {
                        document.getElementsByClassName('edit-email-used')[0].style.display = "block";
                    }
                } else {
                    popups.hide('EditForm');
                }
            });
        };
    }

    self.fillProfile = function(profileBtn) {
        var editForm = document.getElementById('EditForm'),
			id = profileBtn.parentNode.id,
			input = editForm.getElementsByTagName("input");
        getUser.get({ userId: id }).$promise.then(function(user) {			
            input[0].value = user._id;
            input[1].value = user.username;
            input[2].value = user.email;
            input[3].value = user.post;
            input[4].value = user.phone;
            input[5].value = user.password;
            input[6].value = user.fullname;
        });
    }

}])